{% extends "base.html" %}
{% load staticfiles %}
{% block title %}home{% endblock %}
{% block content %}
    <!-- Top image -->
    <div class="wrap-1">
        <div class="container">
            <div class="col-md-7">
                <div class="w1-image top-content-1">
                    <img src="{% static 'images/mac1.png' %}">
                </div>
            </div>

            <div class="col-md-5">
                <div class="description text-center top-content-2">
                    <h2>
                        <i class="fa fa-video-camera"></i>
                        Video Convert
                    </h2>
                    <br>
                    <h5>
                        <p>
                            This web application is aim to convert video to different type of medias. You can simply using it through upload your video or paste a video link.
                        </p> 
                        <br>
                        <p>
                            Currently, this web application support convert video to <i>gif</i> and <i>small size video</i>.
                        </p>
                    </h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Convert Wrap -->
    <div class="wrap-2 container">
        <div class="file-uploader">
            <div class="file-uploader-header clearfix">
                <div class="col-md-12"> 
                    <button class="btn btn-purple upload-file-bottom">
                        <i class="fa fa-upload"></i>
                        Upload File
                    </button>
                    <form id="upload-file-input-form" enctype="multipart/form-data">
                        <input type="file" name="file" id="upload-file-input" accept="video/mp4"/>
                    </form>
                </div>
            </div>
            <div id="drag-file-container">
                <i class="fa fa-upload"></i>
                <span class="upload-text">Upload file or drag your file to here</span>
            </div>

            <div class="video-container-wrap">
                <video id='video-prop' controls>
                    <source id='vp-mp4' src="" type='video/mp4'>    
                    <p>Your user agent does not support the HTML5 Video element.</p>
                </video>
                <div id="video-control-drag"></div>
            </div>

            <div class="file-uploader-footer clearfix">
                <div class="col-md-4">
                    <button class="btn btn-danger reset-video">
                        <i class="fa fa-times"></i>
                        Reset
                    </button>

                    <button class="btn btn-primary generate-video-gif">
                        <i class="fa fa-gavel"></i>
                        Generate
                    </button>
                </div>

                <div class="col-md-8 video-progress-bar-wrap">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped active video-upload-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width:0%;">
                        </div>
                    </div>
                    <div class="vup-text"></div>
                </div>

                <div class="col-md-8 video-convert-result">
                    <a class="vcr-a" href="" target="_blank"></a>
                </div>
            </div>
        </div>

    </div>


    <!-- info 1 -->
    <div class="wrap-3">
        <div class="container">
            <div class="col-md-5">
                <div class="description wp-desc">
                    <h4 class="header-text text-center">
                        <i class="fa fa-rocket"></i>
                        It's Fast
                    </h4>
                    <p>
                        By downloading the resource with a Personal License you are granted the use of it under the conditions featured in the above table. Ownership stays with Creative Tim, along with the copyright holders and you must abide the following rights and restrictions.
                    </p>
                    <p>
                        This pack is a demo of our latest product. You can download it and use it in any project of yours. 
                    </p>
                </div>
            </div>
            <div class="col-md-7">
               <div class="w2-img">
                    <img src="{% static 'images/mac2.png' %}">
               </div>
            </div>
        </div>
    </div>


    <!-- info 2 -->
    <div class="wrap-4">
        <div class="container">
            <div class="col-md-6">
                <div class="w2-img">
                     <img src="{% static 'images/mac3.jpg' %}">
                </div>
            </div>
            <div class="col-md-5 col-md-offset-1">
                <div class="description wp-desc">
                    <h4 class="header-text text-center">
                        <i class="fa fa-picture-o"></i>
                        It's Quality
                    </h4>
                    <p>
                        This pack is a demo of our latest product. You can download it and use it in any project of yours.
                    </p>
                    <p>
                        By downloading the resource with a Personal License you are granted the use of it under the conditions featured in the above table. Ownership stays with Creative Tim, along with the copyright holders and you must abide the following rights and restrictions.
                    </p>
                </div>
            </div>
        </div>
    </div>


    <!-- info 3 -->
    <div class="wrap-5">
        <div class="container">
            <div class="col-md-5">
                <div class="description wp-desc">
                    <h4 class="header-text text-center">
                        <i class="fa fa-simplybuilt"></i>
                        It's Simply
                    </h4>
                    <p>
                        This pack is a demo of our latest product. You can download it and use it in any project of yours.
                    </p>
                    <p>
                        By downloading the resource with a Personal License you are granted the use of it under the conditions featured in the above table. Ownership stays with Creative Tim, along with the copyright holders and you must abide the following rights and restrictions.
                    </p>
                </div>
            </div>
            <div class="col-md-6 col-md-offset-1">
                <div class="w2-img">
                     <img src="{% static 'images/mac4.jpg' %}">
                </div>
            </div>
        </div>
    </div>


    <!-- image scroll -->
    <div class="wrap-6">
        <div class="img-scroll-holder" data-image="{% static 'images/office-wallpaper.jpg' %}"></div>
    </div>


    <!-- carousel -->
    <div class="wrap-7 clearfix">
        <div class="container">
            <h3 class="text-center">
                <i class="fa fa-users"></i>
                Who Use It
            </h3>
            <div class="owl-carousel owl-theme">
                <div class="item">
                    <img src="{% static 'images/client-logo1.png' %}" >
                </div>
                <div class="item">
                    <img src="{% static 'images/client-logo2.png' %}" >
                </div>
                <div class="item">
                    <img src="{% static 'images/client-logo3.png' %}" >
                </div>
                <div class="item">
                    <img src="{% static 'images/client-logo4.png' %}" >
                </div>
                <div class="item">
                    <img src="{% static 'images/client-logo1.png' %}" >
                </div>
                <div class="item">
                    <img src="{% static 'images/client-logo2.png' %}" >
                </div>
                <div class="item">
                    <img src="{% static 'images/client-logo3.png' %}" >
                </div>
                <div class="item">
                    <img src="{% static 'images/client-logo4.png' %}" >
                </div>
            </div>
        </div>
    </div>

    <script src="{% static "js/sweetalert.min.js" %}"></script>
    <script src="{% static "js/owl.carousel.min.js" %}"></script>
    <script src="{% static "js/jquery.imageScroll.min.js" %}"></script>
    <script src="{% static "js/scrollreveal.min.js" %}"></script>
    <script src="{% static "js/pace.min.js" %}"></script>
    <script src="{% static "js/nouislider.min.js" %}"></script>
    <script src="{% static "js/wNumb.js" %}"></script>
    <script type="text/javascript">
        var convert_home_js = (function($){
            // init drag file uploader
            var init_video_parts = function(){
                var _drag_container = document.getElementById('drag-file-container');
                var _video = document.getElementById('video-prop');
                var _video_drag_slider = document.getElementById('video-control-drag');
                var _timeout_id, _video_start_time = 0, _video_end_time = 5, _video_duration = 30;
                var _upload_file_handle;

                // when meta data for the video is loaded
                _video.onloadedmetadata = function() {     
                    _video_duration = _video.duration;
                    _reset_video_slider(0, 5, _video_duration);
                };

                // video drag envet
                _drag_container.ondragover = function (event) {
                    event.preventDefault();
                    event.stopPropagation();
                    return false; 
                };

                _drag_container.ondragend = function (event) {
                    event.preventDefault();
                    event.stopPropagation();
                    return false; 
                };

                _drag_container.ondrop = function (event) { 
                    event.preventDefault();
                    event.stopPropagation();
         
                    reset_video_from_page();

                    var files = event.dataTransfer.files;
                    _upload_file_handle = files[0];       
                    _read_video_blob_data(_upload_file_handle)
                }; 

                // create video slider
                noUiSlider.create(_video_drag_slider, {
                    start: [ _video_start_time, _video_end_time ],
                    behaviour: 'drag',
                    connect: true,
                    margin: 1,
                    step : 1,
                    tooltips: [ wNumb({ decimals: 0 }), wNumb({ decimals: 0 }) ],
                    range: {
                        'min':  0,
                        'max':  _video_duration
                    }
                });

                // listening the video slider evnet 
                _video_drag_slider.noUiSlider.on('change', function( data, handle){
                    _video_start_time = data[0],
                    _video_end_time = data[1];

                    // clear timeout
                    clearTimeout(_timeout_id);

                    // set start time
                    _video.currentTime = _video_start_time;
                    _video.play();

                    // paused when reach the end time
                    _timeout_id = setTimeout(function(){ 
                        _video.pause();
                    }, (_video_end_time-_video_start_time+1)*1000);
                });


                // test browser support
                var _test_browser = function(){
                    // test browser support html5 video or not
                    var test_env = {
                        filereader: typeof FileReader != 'undefined',
                        dnd: 'draggable' in document.createElement('span'),
                        formdata: !!window.FormData,
                        progress: "upload" in new XMLHttpRequest
                    };

                    "filereader formdata progress".split(' ').forEach(function (api) {
                        if (test_env[api] === false) {
                            alert('do not support drag upload!');
                        }
                    });
                }

                // loading icon
                var _fa_loading_icon = function(){
                    return '<i class="fa fa-spin fa-spinner"></i>';
                }

                // reset all div
                var _reset_all_elements = function(){
                    $('.video-convert-result').hide();
                    $('.video-progress-bar-wrap').hide();
                    $('.video-container-wrap').hide();
                    $('#video-control-drag').hide();
                    $('#drag-file-container').show();
                    $('#vp-mp4').attr('src', '');
                }

                // send uploaded video data to server
                var send_request = function(form_data){
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/convert/video');
     
                    xhr.upload.onloadstart = function (event) {
                        $('.video-progress-bar-wrap').show();
                        $('.video-convert-result').hide();
                        $('.vup-text').text('Converting...');
                    }

                    xhr.upload.onprogress = function (event) {
                        if (event.lengthComputable) {
                            var complete_percentage = (event.loaded / event.total * 100 | 0);
                            $('.video-upload-progress').width(complete_percentage+'%');
                        }
                    }

                    xhr.onload = function(result) {
                        var res_json = jQuery.parseJSON(xhr.responseText);
                        if(!res_json.error){
                            $('.video-convert-result').show();
                            $('.vcr-a').attr('href', res_json.response_file).text(res_json.response_file);
                            $('.video-progress-bar-wrap').hide();
                        }
                    };

                    xhr.send(form_data);
                }

           
                // generate gif from video
                var generate_gif = function(event){
                    var _gif_time_length = _video_end_time - _video_start_time;
                    var form_data = new FormData();
                    
                    if($('#vp-mp4').attr('src') == ''){
                        swal({
                            title: "Error!",
                            text: "Please upload a video first.",
                            type: "error",
                            confirmButtonText: "Cool" 
                        });       
                        return;
                    }
                    form_data.append('file', _upload_file_handle);
                    form_data.append('type', 'gif');
                    form_data.append('start_timestamps', _video_start_time);
                    form_data.append('gif_duration', _gif_time_length);
                    send_request(form_data);
                }

                // upload file trigger event
                var upload_file_trigger = function(){
                    $('#upload-file-input').trigger('click');
                }

                // upload file
                var upload_file = function(event){
                    var files = document.getElementById('upload-file-input').files;
                    _upload_file_handle = files[0];

                    reset_video_from_page();
                    _read_video_blob_data(_upload_file_handle);
                }


                // reset video slider 
                var _reset_video_slider = function(starttime, endtime, duration){
                    // update video slider range
                    _video_drag_slider.noUiSlider.set([starttime, endtime]);
                    _video_drag_slider.noUiSlider.updateOptions({
                        range: {
                            'min': 0,
                            'max': parseInt(duration)
                        }
                    });
                }

                // show all video related elements or not
                var _show_or_hide_video_elements = function(type){
                    if(type == 'show'){
                        $('.video-container-wrap').show();
                        $('#drag-file-container').hide();
                        $('.video-progress-bar-wrap').hide();
                        $('#video-control-drag').fadeIn();
                    }else{
                        $('.video-container-wrap').hide();
                        $('#drag-file-container').show();
                        $('.video-progress-bar-wrap').show();
                        $('#video-control-drag').hide();
                    }
                }

                // show video preview
                var _show_video_preview = function(video_blob_url){
                    $('#vp-mp4').attr('src', video_blob_url);
                    _video.load();
               
                    _show_or_hide_video_elements('show');
                }

                // read video blob data
                var _read_video_blob_data = function(file){
                    var reader = new FileReader(),
                        mime = file.type;

                    // only support mp4 video
                    if(mime != 'video/mp4'){
                        swal({
                            title: "Error!",
                            text: "Sorry, we only support mp4 video!",
                            type: "error",
                            confirmButtonText: "Cool" 
                        });      
                        return;
                    }

                    reader.readAsArrayBuffer(file);

                    // The load event is fired when a resource and its dependent resources have finished loading.
                    reader.onload = function(evt) {
                        if (evt.target.readyState == FileReader.DONE) { 
                            var blob = new Blob([evt.target.result], {type: mime}),     
                                video_blob_url = (URL || webkitURL).createObjectURL(blob);
                          
                            _show_video_preview(video_blob_url);    
                        }
                    }  
                }

                // reset/remove video from page
                var reset_video_from_page = function(event){
                    _reset_all_elements();
                }

                return {
                    load : function(){
                        _test_browser();
                        $('.generate-video-gif').on('click', generate_gif);
                        $('.reset-video').on('click', reset_video_from_page);
                        $('.upload-file-bottom').on('click', upload_file_trigger);
                        $('#upload-file-input').on('change', upload_file);
                    }
                }
            }

            // content scroll 
            var init_content_scroll = function(){
                window.sr = ScrollReveal({
                    reset:true
                }).reveal('.wrap-3, .wrap-4, .wrap-5');

                sr.reveal('.top-content-1', {
                    delay    : 200,
                    distance : '90px',
                    origin : 'bottom',
                    scale    : 1.1
                });

                sr.reveal('.top-content-2', {
                    delay    : 200,
                    origin : 'top',
                    distance : '90px',
                    scale    : 1.1
                });
            }

            // init image scroll
            var init_image_scroll = function(){
                $('.img-scroll-holder').imageScroll({
                    coverRatio: 0.5
                });
            }

            // init carousel
            var init_carousel = function(){
                $('.owl-carousel').owlCarousel({
                    loop:true,
                    margin:10,
                    nav:false,
                    responsive:{
                        0:{
                            items:1
                        },
                        600:{
                            items:3
                        },
                        1000:{
                            items:5
                        }
                    }
                })
            }

            return {
                bind : function(){

                },
                init : function(){
                    init_video_parts().load();
                    init_content_scroll();
                    init_image_scroll();
                    init_carousel();
                }
            }
        })($);
        
        convert_home_js.bind();
        convert_home_js.init();      
    </script>
{% endblock %}
